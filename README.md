# 사용방법
            
img = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)
img = cv2.resize(img, (512, 512))
img_normalized = img / 255.0

### 1-2차 처리 (기존 방식)
primary_mask, secondary_mask, _, _ = improved_weighted_average_segmentation(img_normalized)

### 3차 처리 (개선된 방식)
tertiary_mask = apply_tertiary_filtering_improved(secondary_mask)

### 4차 처리
final_result = img_normalized * tertiary_mask




# 폐 분할 알고리즘 코드 분석

## 개요
이 코드는 X-ray 흉부 이미지에서 폐 영역을 자동으로 추출하는 **4단계 필터링 폐 분할 알고리즘**입니다. 의료 영상 처리에서 중요한 전처리 단계로 사용됩니다.

## 전체 구조

### 메인 함수: `improved_weighted_average_segmentation(img)`

**입력**: 정규화된 그레이스케일 이미지 (0-1 범위)  
**출력**: 4단계 처리 결과 (primary_mask, secondary_mask, tertiary_mask, final_result)

## 4단계 필터링 과정

### 1단계: Primary Mask (기본 임계값 + 형태학적 처리)

```python
# 핵심 처리 과정
1. 가중 평균 기반 최적 임계값 계산
2. 동적 임계값 조정 (이미지 밝기에 따라)
3. 이진화 수행
4. 침대/테이블 영역 조기 제거
5. 하단 영역 특별 처리
6. 연결된 컴포넌트 분석
7. 형태학적 정제
```

**주요 특징:**
- **Otsu 방법 개선**: 분산을 최대화하는 임계값을 동적으로 계산
- **적응적 임계값**: 이미지 평균 밝기에 따라 임계값 조정
- **침대 제거**: X-ray에서 흔히 나타나는 침대/테이블 영역을 조기에 제거

### 2단계: Secondary Filtering (위치, 크기, 형태 기반 필터링)

```python
def apply_secondary_filtering(mask, original_img):
    # 연결된 컴포넌트별로 9가지 조건 검사
    1. 위치 기반 필터링 (중심으로부터 거리)
    2. 세로/가로 비율 검사
    3. 영역 크기 검사
    4. 경계와의 거리 검사
    5. 원형도(circularity) 검사
    6. 밀도(intensity) 기반 필터링
    7. 하단 영역 침대 제거 강화
    8. 수평선 패턴 검사
    9. 하단 곡선 형태 특별 검사
```

**주요 특징:**
- **완화된 조건**: 과도한 필터링을 방지하기 위해 조건들을 적절히 완화
- **다중 검증**: 여러 기하학적/물리적 특성을 종합적으로 판단
- **침대 패턴 인식**: 의료 장비 특성을 고려한 노이즈 제거

### 3단계: Tertiary Filtering (양쪽 폐 보존 시드 기반 확장)

#### 기존 방식 (Original)
```python
def apply_tertiary_filtering_original(mask):
    # 단순히 가장 큰 영역 1-2개만 선택
    - 면적 순으로 정렬
    - 가장 큰 영역 + 조건부로 두 번째 영역 선택
```

#### 개선된 방식 (Improved)
```python
def apply_tertiary_filtering_improved(mask):
    # 양쪽 폐를 모두 보존하는 시드 기반 확장
    1. 좌우 분리 시드 검색
    2. 연결된 컴포넌트 기반 백업 검색
    3. 양쪽 폐 각각 처리
    4. 강제 양쪽 폐 복원 (안전장치)
    5. 형태학적 정제
    6. 최종 검증 및 정리
```

**핵심 개선사항:**
- **양쪽 폐 보장**: 한쪽 폐가 누락되는 것을 방지
- **시드 기반 확장**: Region Growing 알고리즘 적용
- **다중 안전장치**: 여러 단계의 복원 메커니즘

### 4단계: Final Result (원본 × 3단계 마스크)

```python
final_result = img * tertiary_mask
```

단순한 픽셀별 곱셈으로 배경을 제거하고 폐 영역만 보존

## 핵심 알고리즘 상세

### 시드 기반 폐 검출 (`find_bilateral_lung_seeds`)

```python
def find_bilateral_lung_seeds(mask, h, w):
    # 좌우로 분할 (10% 오버랩)
    # 각 쪽에서 여러 위치에서 시드 찾기
    # 거리 기반 우선순위로 최적 시드 선택
```

**특징:**
- **양쪽 독립 처리**: 좌우 폐를 별도로 분석
- **다중 검색점**: 여러 중심점에서 시드 탐색
- **거리 기반 우선순위**: 해부학적으로 적절한 위치 우선

### Region Growing (`region_growing_for_lung`)

```python
def region_growing_for_lung(mask, seed_x, seed_y, h, w):
    # 시드에서 시작하여 점진적 확장
    kernel_sizes = [3, 5, 7, 9]  # 점진적 확장
    # 각 단계마다 형태 검증
    # 과도한 확장 방지 메커니즘
```

**특징:**
- **점진적 확장**: 작은 커널부터 단계적으로 확장
- **경계 제약**: 원본 마스크 영역을 벗어나지 않음
- **크기 제한**: 과도한 확장 방지

### 강제 복원 메커니즘 (`force_bilateral_recovery`)

```python
def force_bilateral_recovery(original_mask, current_mask, h, w):
    # 좌우 영역 면적 확인
    # 부족한 쪽의 영역을 원본에서 복원
    # 매우 관대한 조건으로 후보 선정
```

**특징:**
- **최후의 안전장치**: 다른 방법이 실패했을 때 작동
- **양쪽 폐 보장**: 의학적으로 중요한 양쪽 폐 모두 보존
- **관대한 복원**: 놓친 폐 영역을 적극적으로 복원

## 기술적 특징

### 사용된 주요 라이브러리
- **OpenCV**: 이미지 처리, 형태학적 연산
- **scikit-image**: 연결된 컴포넌트 분석, 영역 특성 계산
- **NumPy**: 수치 연산, 배열 처리
- **SciPy**: 고급 이미지 처리 함수

### 핵심 컴퓨터 비전 기법
1. **적응적 임계값**: 이미지별 최적 임계값 자동 계산
2. **형태학적 연산**: Opening, Closing으로 노이즈 제거
3. **연결된 컴포넌트 분석**: 개별 객체 식별 및 특성 분석
4. **Region Growing**: 시드에서 시작하는 영역 확장
5. **다중 기하학적 필터**: 면적, 종횡비, 원형도, 위치 등

### 의료 영상 특화 처리
- **침대/테이블 제거**: X-ray 촬영 환경의 노이즈 제거
- **해부학적 제약**: 폐의 위치와 형태에 대한 의학적 지식 활용
- **양쪽 폐 보존**: 병리학적 진단을 위한 완전성 보장

## 성능 및 강건성

### 강점
1. **높은 정확도**: 4단계 필터링으로 정밀한 분할
2. **강건성**: 다양한 이미지 품질에 대응
3. **의학적 타당성**: 해부학적 지식 기반 처리
4. **완전성**: 양쪽 폐 모두 보존 보장

### 개선 포인트
- **연산 복잡도**: 4단계 처리로 인한 계산 시간 증가
- **매개변수 조정**: 임계값들의 수동 튜닝 필요
- **특수 케이스**: 심각한 병변이나 수술 흔적 처리 한계

## 활용 분야
- **의료 영상 진단**: 폐질환 자동 진단 시스템
- **AI 의료 모델**: 딥러닝 모델의 전처리 단계
- **대량 스크리닝**: 대규모 X-ray 이미지 자동 분석
- **연구 도구**: 폐 관련 의학 연구의 정량적 분석
