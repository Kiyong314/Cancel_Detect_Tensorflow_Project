
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusNet-LC 폐암 진단</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .upload-section {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }
        
        .file-input {
            display: none;
        }
        
        .file-input-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .predict-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            margin-left: 20px;
            transition: all 0.3s;
        }
        
        .predict-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .predict-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .results-section {
            display: none;
            margin-top: 40px;
        }
        
        .prediction-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .prediction-result {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .confidence {
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        
        .all-predictions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .prediction-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .images-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .image-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .image-card h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .image-card img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .doctor-section {
            display: none;
            background: #fff9e6;
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }
        
        .doctor-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
            color: #856404;
            font-weight: bold;
        }
        
        .doctor-form {
            max-width: 700px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .form-group select, .form-group textarea, .form-group input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-group input[type="radio"] {
            margin-right: 10px;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .radio-option:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }
        
        .radio-option input[type="radio"]:checked + span {
            color: #007bff;
            font-weight: bold;
        }
        
        .submit-doctor-button {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }
        
        .submit-doctor-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .survey-section {
            display: none;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }
        
        .survey-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }
        
        .survey-form {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .survey-form .form-group input[type="radio"] {
            margin-right: 10px;
        }
        
        .survey-form .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .survey-form .radio-option {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #ddd;
        }
        
        .survey-form .radio-option:hover {
            background: #e9ecef;
        }
        
        .survey-form input[type="number"], .survey-form input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .submit-survey-button {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }
        
        .submit-survey-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .recommendations-section {
            display: none;
            margin-top: 30px;
        }
        
        .recommendations-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .priority-banner {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .priority-low {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .priority-medium {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        
        .priority-high {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .priority-urgent {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .ai-vs-doctor {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .diagnosis-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .diagnosis-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .agreement-status {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .agreement-true {
            background: #d4edda;
            color: #155724;
        }
        
        .agreement-false {
            background: #f8d7da;
            color: #721c24;
        }
        
        .appointment-card {
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .appointment-confirmed {
            color: #155724;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .recommendation-category {
            margin-bottom: 25px;
        }
        
        .recommendation-category h4 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ddd;
        }
        
        .recommendation-list {
            list-style: none;
            padding: 0;
        }
        
        .recommendation-list li {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .recommendation-list li:before {
            content: "✓ ";
            color: #28a745;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .smoking-advice li {
            border-left-color: #dc3545;
        }
        
        .exercise-advice li {
            border-left-color: #28a745;
        }
        
        .medical-advice li {
            border-left-color: #ffc107;
        }
        
        .lifestyle-advice li {
            border-left-color: #17a2b8;
        }
        
        .followup-advice li {
            border-left-color: #6f42c1;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        .admin-message {
            background: #ffc107;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            text-align: center;
        }
        
        .admin-message h4 {
            margin-bottom: 10px;
            color: #856404;
        }
        
        @media (max-width: 768px) {
            .images-container {
                grid-template-columns: 1fr;
            }
            
            .predict-button {
                margin-left: 0;
                margin-top: 10px;
            }
            
            .radio-group {
                flex-direction: column;
            }
            
            .diagnosis-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI Bread Scan</h1>
            <p>AI 기반 폐암 진단 시스템 (서강대 AISW 텐서플로 활용기초)</p>
        </div>
        
        <div class="content">
            <div class="upload-section">
                <h2>CT 이미지를 업로드하세요</h2>
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" accept=".png,.jpg,.jpeg">
                    <button class="file-input-button" onclick="document.getElementById('fileInput').click()">
                        📁 파일 선택
                    </button>
                </div>
                <button class="predict-button" id="predictButton" disabled onclick="predict()">
                    🔍 진단 시작
                </button>
                <div id="fileName" style="margin-top: 10px; color: #666;"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>AI가 이미지를 분석하고 있습니다...</p>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            
            <div class="admin-message" id="adminMessage">
                <h4>⚠️ 전처리 실패</h4>
                <p id="adminMessageText"></p>
            </div>
            
            <div class="results-section" id="resultsSection">
                <div class="prediction-card">
                    <div class="prediction-result" id="predictionResult"></div>
                    <div class="confidence" id="confidence"></div>
                    <div class="all-predictions" id="allPredictions"></div>
                </div>
                
                <div class="images-container">
                    <div class="image-card">
                        <h3>📷 원본 이미지</h3>
                        <img id="originalImage" src="" alt="원본 이미지">
                    </div>
                    <div class="image-card">
                        <h3>🔍 전처리된 이미지</h3>
                        <img id="processedImage" src="" alt="전처리된 이미지">
                    </div>
                    <div class="image-card">
                        <h3>🎯 Grad-CAM 히트맵</h3>
                        <img id="gradcamImage" src="" alt="Grad-CAM 히트맵">
                    </div>
                </div>
            </div>
            
            <!-- 의사 진단 섹션 -->
            <div class="doctor-section" id="doctorSection">
                <h3 class="doctor-title">🩺 의사 진단 및 소견</h3>
                <p style="text-align: center; margin-bottom: 30px; color: #856404;">
                    AI 분석 결과를 검토하시고 최종 진단을 입력해주세요.
                </p>
                
                <form class="doctor-form" id="doctorForm">
                    <div class="form-group">
                        <label>최종 진단 결과</label>
                        <select name="final_diagnosis" required>
                            <option value="">선택해주세요</option>
                            <option value="Normal">정상 (Normal)</option>
                            <option value="Benign">양성 병변 (Benign)</option>
                            <option value="Malignant">악성 병변 (Malignant)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>의사 소견 및 추가 의견</label>
                        <textarea name="notes" placeholder="진단 소견, 추가 검사 필요성, 주의사항 등을 입력해주세요..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>다음 진료 필요 여부</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="next_visit_needed" value="false" required>
                                <span>불필요 (정기 검진으로 충분)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="next_visit_needed" value="true" required>
                                <span>필요 (추적 관찰 또는 정밀검사)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group" id="nextVisitDateGroup" style="display: none;">
                        <label>권장 다음 진료일</label>
                        <input type="date" name="next_visit_date" min="">
                    </div>
                    
                    <button type="submit" class="submit-doctor-button">
                        💾 진단 완료
                    </button>
                </form>
            </div>
            
            <!-- 설문조사 섹션 -->
            <div class="survey-section" id="surveySection">
                <h3 class="survey-title">📋 건강 설문조사 및 예약</h3>
                <p style="text-align: center; margin-bottom: 30px; color: #666;">
                    더 정확한 건강 권고사항을 위해 간단한 설문에 참여해주세요.
                </p>
                
                <form class="survey-form" id="surveyForm">
                    <div class="form-group">
                        <label>1. 현재 흡연 상태는 어떠신가요?</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="smoking" value="false" required>
                                <span>🚭 비흡연자 (흡연한 적 없음)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="smoking" value="false" required>
                                <span>🚫 금연자 (과거 흡연, 현재 금연)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="smoking" value="true" required>
                                <span>🚬 현재 흡연자</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>2. 평소 운동은 얼마나 자주 하시나요?</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="exercise" value="0" required>
                                <span>😴 운동을 거의 하지 않음</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="exercise" value="1" required>
                                <span>🚶‍♂️ 가끔 운동함 (주 1-2회)</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="exercise" value="2" required>
                                <span>🏃‍♂️ 정기적으로 운동함 (주 3회 이상)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="age">3. 연령을 입력해주세요:</label>
                        <input type="number" id="age" name="age" min="1" max="120" value="40" required>
                    </div>
                    
                    <div class="form-group" id="appointmentGroup" style="display: none;">
                        <label for="appointment_date">4. 다음 진료 예약일을 선택해주세요:</label>
                        <input type="date" id="appointment_date" name="appointment_date" min="">
                    </div>
                    
                    <button type="submit" class="submit-survey-button">
                        📊 건강 권고사항 받기
                    </button>
                </form>
            </div>
            
            <!-- 건강 권고사항 섹션 -->
            <div class="recommendations-section" id="recommendationsSection">
                <div class="recommendations-card">
                    <h3 style="text-align: center; margin-bottom: 20px; color: #333;">
                        💡 개인화된 건강 권고사항
                    </h3>
                    
                    <div id="priorityBanner" class="priority-banner"></div>
                    
                    <!-- AI vs 의사 진단 비교 -->
                    <div id="aiVsDoctorComparison" class="ai-vs-doctor">
                        <h4 style="margin-bottom: 15px; color: #1976d2;">🤖 AI vs 👨‍⚕️ 의사 진단 비교</h4>
                        <div class="diagnosis-comparison">
                            <div class="diagnosis-item">
                                <h5>AI 진단</h5>
                                <div id="aiDiagnosisResult"></div>
                                <small id="aiConfidence"></small>
                            </div>
                            <div class="diagnosis-item">
                                <h5>의사 진단</h5>
                                <div id="doctorDiagnosisResult"></div>
                            </div>
                        </div>
                        <div id="agreementStatus" class="agreement-status"></div>
                        <div id="doctorNotesDisplay" style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;"></div>
                    </div>
                    
                    <!-- 예약 완료 카드 -->
                    <div id="appointmentCard" class="appointment-card" style="display: none;">
                        <div class="appointment-confirmed">✅ 예약 완료</div>
                        <div id="appointmentDetails"></div>
                    </div>
                    
                    <div id="medicalAdvice" class="recommendation-category">
                        <h4>🏥 의료 관련 권고사항</h4>
                        <ul class="recommendation-list medical-advice"></ul>
                    </div>
                    
                    <div id="smokingAdvice" class="recommendation-category">
                        <h4>🚭 흡연 관련 권고사항</h4>
                        <ul class="recommendation-list smoking-advice"></ul>
                    </div>
                    
                    <div id="exerciseAdvice" class="recommendation-category">
                        <h4>🏃‍♂️ 운동 관련 권고사항</h4>
                        <ul class="recommendation-list exercise-advice"></ul>
                    </div>
                    
                    <div id="lifestyleAdvice" class="recommendation-category">
                        <h4>🌱 생활습관 권고사항</h4>
                        <ul class="recommendation-list lifestyle-advice"></ul>
                    </div>
                    
                    <div id="followupAdvice" class="recommendation-category">
                        <h4>📅 추후 관리 계획</h4>
                        <ul class="recommendation-list followup-advice"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPredictionResult = null;
        let currentDoctorDiagnosis = null;
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const predictButton = document.getElementById('predictButton');
            const fileName = document.getElementById('fileName');
            
            if (file) {
                fileName.textContent = `선택된 파일: ${file.name}`;
                predictButton.disabled = false;
            } else {
                fileName.textContent = '';
                predictButton.disabled = true;
            }
        });
        
        // 의사 진단 폼 이벤트 리스너
        document.getElementById('doctorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitDoctorDiagnosis();
        });
        
        // 다음 진료 필요 여부에 따른 날짜 필드 표시/숨김
        document.querySelectorAll('input[name="next_visit_needed"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const dateGroup = document.getElementById('nextVisitDateGroup');
                const dateInput = document.querySelector('input[name="next_visit_date"]');
                
                if (this.value === 'true') {
                    dateGroup.style.display = 'block';
                    dateInput.required = true;
                    // 최소 날짜를 내일로 설정
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    dateInput.min = tomorrow.toISOString().split('T')[0];
                } else {
                    dateGroup.style.display = 'none';
                    dateInput.required = false;
                    dateInput.value = '';
                }
            });
        });
        
        document.getElementById('surveyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitSurvey();
        });
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 10000);
        }
        
        function showAdminMessage(message) {
            const adminDiv = document.getElementById('adminMessage');
            const adminText = document.getElementById('adminMessageText');
            adminText.textContent = message;
            adminDiv.style.display = 'block';
            
            setTimeout(() => {
                adminDiv.style.display = 'none';
            }, 15000);
        }
        
        async function predict() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('파일을 선택해주세요.');
                return;
            }
            
            // UI 상태 변경
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('doctorSection').style.display = 'none';
            document.getElementById('surveySection').style.display = 'none';
            document.getElementById('recommendationsSection').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('adminMessage').style.display = 'none';
            document.getElementById('predictButton').disabled = true;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.error) {
                    if (result.admin_notification) {
                        showAdminMessage(result.message || result.error);
                    } else {
                        showError(result.error);
                    }
                    return;
                }
                
                // 현재 예측 결과 저장
                currentPredictionResult = result;
                
                // 결과 표시
                document.getElementById('predictionResult').textContent = result.prediction;
                document.getElementById('predictionResult').style.color = result.color;
                document.getElementById('confidence').textContent = `신뢰도: ${result.confidence}%`;
                
                // 모든 예측 결과 표시
                const allPredDiv = document.getElementById('allPredictions');
                allPredDiv.innerHTML = '';
                for (const [className, confidence] of Object.entries(result.all_predictions)) {
                    const div = document.createElement('div');
                    div.className = 'prediction-item';
                    div.innerHTML = `<strong>${className}</strong><br>${confidence}%`;
                    allPredDiv.appendChild(div);
                }
                
                // 이미지 표시
                document.getElementById('originalImage').src = result.original_image;
                document.getElementById('processedImage').src = result.processed_image;
                if (result.gradcam_image) {
                    document.getElementById('gradcamImage').src = result.gradcam_image;
                }
                
                document.getElementById('resultsSection').style.display = 'block';
                
                // 의사 진단 섹션 표시
                if (result.need_doctor_input) {
                    setTimeout(() => {
                        document.getElementById('doctorSection').style.display = 'block';
                        document.getElementById('doctorSection').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }, 1000);
                }
                
            } catch (error) {
                showError('서버 연결 오류가 발생했습니다.');
                console.error('Error:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('predictButton').disabled = false;
            }
        }
        
        async function submitDoctorDiagnosis() {
            if (!currentPredictionResult) {
                showError('진단 결과가 없습니다. 먼저 이미지 진단을 수행해주세요.');
                return;
            }
            
            const formData = new FormData(document.getElementById('doctorForm'));
            const doctorData = {
                ai_result: currentPredictionResult,
                final_diagnosis: formData.get('final_diagnosis'),
                notes: formData.get('notes'),
                next_visit_needed: formData.get('next_visit_needed') === 'true',
                next_visit_date: formData.get('next_visit_date')
            };
            
            try {
                const response = await fetch('/doctor_diagnosis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(doctorData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentDoctorDiagnosis = result.doctor_diagnosis;
                    
                    // 설문조사 섹션 표시
                    setTimeout(() => {
                        document.getElementById('surveySection').style.display = 'block';
                        
                        // 다음 진료가 필요한 경우에만 예약 필드 표시
                        const appointmentGroup = document.getElementById('appointmentGroup');
                        const appointmentInput = document.getElementById('appointment_date');
                        
                        if (result.doctor_diagnosis.next_visit_needed) {
                            appointmentGroup.style.display = 'block';
                            appointmentInput.required = true;
                            
                            // 권장 날짜가 있으면 기본값으로 설정
                            if (result.doctor_diagnosis.next_visit_date) {
                                appointmentInput.value = result.doctor_diagnosis.next_visit_date;
                            }
                            
                            // 최소 날짜를 내일로 설정
                            const tomorrow = new Date();
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            appointmentInput.min = tomorrow.toISOString().split('T')[0];
                        } else {
                            // 다음 진료가 필요하지 않은 경우 예약 필드 숨김
                            appointmentGroup.style.display = 'none';
                            appointmentInput.required = false;
                            appointmentInput.value = '';
                        }
                        
                        document.getElementById('surveySection').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }, 500);
                } else {
                    showError(result.error || '의사 진단 저장 중 오류가 발생했습니다.');
                }
                
            } catch (error) {
                showError('서버 연결 오류가 발생했습니다.');
                console.error('Error:', error);
            }
        }
        
        async function submitSurvey() {
            if (!currentPredictionResult || !currentDoctorDiagnosis) {
                showError('진단 결과가 없습니다. 처음부터 다시 진행해주세요.');
                return;
            }
            
            const formData = new FormData(document.getElementById('surveyForm'));
            const surveyData = {
                prediction_result: currentPredictionResult,
                doctor_diagnosis: currentDoctorDiagnosis,
                smoking: formData.get('smoking') === 'true',
                exercise: parseInt(formData.get('exercise')),
                age: parseInt(formData.get('age')),
                appointment_date: formData.get('appointment_date')
            };
            
            try {
                const response = await fetch('/health_recommendations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(surveyData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayRecommendations(result.recommendations, result.appointment);
                } else {
                    showError(result.error || '권고사항 생성 중 오류가 발생했습니다.');
                }
                
            } catch (error) {
                showError('서버 연결 오류가 발생했습니다.');
                console.error('Error:', error);
            }
        }
        
        function displayRecommendations(recommendations, appointment) {
            // 우선순위 배너 설정
            const priorityBanner = document.getElementById('priorityBanner');
            const priorityTexts = {
                'low': '✅ 저위험군 - 예방 관리 중심',
                'medium': '⚠️ 중위험군 - 적극적 관리 필요',
                'high': '🚨 고위험군 - 신속한 대응 필요',
                'urgent': '🆘 긴급 - 즉시 의료진 상담 필요'
            };
            
            priorityBanner.textContent = priorityTexts[recommendations.priority];
            priorityBanner.className = `priority-banner priority-${recommendations.priority}`;
            
            // AI vs 의사 진단 비교 표시
            const aiVsDoctor = recommendations.ai_vs_doctor;
            document.getElementById('aiDiagnosisResult').textContent = aiVsDoctor.ai_diagnosis;
            document.getElementById('aiConfidence').textContent = `(신뢰도: ${aiVsDoctor.ai_confidence}%)`;
            document.getElementById('doctorDiagnosisResult').textContent = aiVsDoctor.doctor_diagnosis;
            
            const agreementStatus = document.getElementById('agreementStatus');
            if (aiVsDoctor.agreement) {
                agreementStatus.textContent = '✅ AI와 의사 진단이 일치합니다';
                agreementStatus.className = 'agreement-status agreement-true';
            } else {
                agreementStatus.textContent = '⚠️ AI와 의사 진단이 다릅니다 (의사 진단을 우선적용)';
                agreementStatus.className = 'agreement-status agreement-false';
            }
            
            // 의사 소견 표시
            const doctorNotesDisplay = document.getElementById('doctorNotesDisplay');
            if (recommendations.doctor_notes) {
                doctorNotesDisplay.innerHTML = `<strong>의사 소견:</strong> ${recommendations.doctor_notes}`;
                doctorNotesDisplay.style.display = 'block';
            } else {
                doctorNotesDisplay.style.display = 'none';
            }
            
            // 예약 정보 표시
            if (appointment && appointment.date) {
                const appointmentCard = document.getElementById('appointmentCard');
                const appointmentDetails = document.getElementById('appointmentDetails');
                
                appointmentDetails.textContent = appointment.message;
                appointmentCard.style.display = 'block';
            }
            
            // 각 카테고리별 권고사항 표시
            const categories = [
                { id: 'medicalAdvice', key: 'medical_advice' },
                { id: 'smokingAdvice', key: 'smoking_advice' },
                { id: 'exerciseAdvice', key: 'exercise_advice' },
                { id: 'lifestyleAdvice', key: 'lifestyle_advice' },
                { id: 'followupAdvice', key: 'followup_advice' }
            ];
            
            categories.forEach(category => {
                const adviceList = recommendations[category.key] || [];
                const listElement = document.querySelector(`#${category.id} .recommendation-list`);
                
                if (adviceList.length > 0) {
                    listElement.innerHTML = '';
                    adviceList.forEach(advice => {
                        const li = document.createElement('li');
                        li.textContent = advice;
                        listElement.appendChild(li);
                    });
                    document.getElementById(category.id).style.display = 'block';
                } else {
                    document.getElementById(category.id).style.display = 'none';
                }
            });
            
            // 권고사항 섹션 표시 및 스크롤
            document.getElementById('recommendationsSection').style.display = 'block';
            setTimeout(() => {
                document.getElementById('recommendationsSection').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 300);
        }
    </script>
</body>
</html>
